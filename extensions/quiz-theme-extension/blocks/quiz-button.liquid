{{ 'quiz-button.css' | asset_url | stylesheet_tag }}

<div class="quiz-button-container" data-quiz-slug="{{ block.settings.quiz_slug }}">
  <button 
    class="quiz-button-main"
    data-quiz-slug="{{ block.settings.quiz_slug }}"
    style="
      --button-bg-color: {{ block.settings.button_color }};
      --button-text-color: {{ block.settings.text_color }};
      --button-border-color: {{ block.settings.border_color }};
      --button-border-width: {{ block.settings.border_width }}px;
      --button-border-radius: {{ block.settings.border_radius }}px;
      --button-padding: {{ block.settings.button_padding }}px;
      --button-font-size: {{ block.settings.font_size }}px;
    "
  >
    {{ block.settings.button_text | default: 'Quiz Başlat' }}
  </button>
</div>

<!-- Quiz Modal -->
<div id="quiz-modal" class="quiz-modal" style="display: none;" onclick="closeQuizModalIfOutside(event)">
  <div class="quiz-modal-content" onclick="event.stopPropagation()">
    <div id="quiz-container"></div>
  </div>
</div>

<script>
  (function() {
    // Quiz modal functionality
    let currentQuiz = null;
    let currentView = 'info';
    let currentQuestionIndex = 0;
    let selectedAnswers = [];
    let allAnswers = {};

    // Default styles - Match database StyleSettings interface exactly
    const defaultStyles = {
      // General
      fontFamily: 'Arial, sans-serif',
      animations: true,
      
      // Intro Screen
      introBackgroundColor: '#f8f9fa',
      introStartButtonColor: '#d63384',
      introStartButtonTextColor: '#ffffff',
      introQuestionTextColor: '#212529',
      introDescriptionTextColor: '#6c757d',
      introStartButtonBorderColor: '#d63384',
      introImageBorderColor: '#dee2e6',
      introButtonBorderWidth: 0,
      introButtonBorderRadius: 25,
      introButtonBorderType: 'solid',
      introImageBorderWidth: 0,
      introImageBorderRadius: 20,
      introImageBorderType: 'solid',
      introTitleSize: 32,
      introDescriptionSize: 14,
      introButtonTextSize: 16,
      introIconSize: 20,
      introImageHeight: 100,
      
      // Question Screen  
      questionBackgroundColor: '#f8f9fa',
      questionOptionBackgroundColor: '#ffffff',
      questionOptionBorderColor: '#dee2e6',
      questionTextColor: '#212529',
      questionOptionTextColor: '#495057',
      questionImageBorderColor: '#dee2e6',
      questionSelectedOptionBackgroundColor: '#d63384',
      questionSelectedOptionTextColor: '#ffffff',
      questionSelectedOptionBorderColor: '#d63384',
      questionOptionBorderWidth: 1,
      questionOptionBorderRadius: 15,
      questionOptionBorderType: 'solid',
      questionImageBorderWidth: 0,
      questionImageBorderRadius: 15,
      questionImageBorderType: 'solid',
      questionTextSize: 24,
      questionImageHeight: 200,
      questionOptionTextSize: 14,
      questionOptionImageSize: 100,
      
      // Navigation
      navButtonBorderWidth: 0,
      navButtonBorderColor: '#dee2e6',
      navButtonBorderType: 'solid',
      navButtonBorderRadius: 20,
      navButtonTextSize: 14,
      navButtonTextType: 'normal',
      navPrevButtonColor: '#6c757d',
      navPrevButtonTextColor: '#ffffff',
      navOkIconColor: '#d63384',
      
      // Counter
      counterBackgroundColor: 'rgba(214, 51, 132, 0.1)',
      counterBorderColor: '#d63384',
      counterTextColor: '#d63384',
      counterBorderWidth: 1,
      counterBorderRadius: 15,
      counterBorderType: 'solid',
      counterTextSize: 12,
      counterTextStyle: 'normal',
      
      // Results
      resultBackgroundColor: '#f8f9fa',
      resultButtonColor: '#d63384',
      resultButtonTextColor: '#ffffff',
      resultTextColor: '#212529',
      
      // Custom CSS
      customCSS: ''
    };

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      initializeQuizButtons();
    });

    function initializeQuizButtons() {
      const quizButtons = document.querySelectorAll('.quiz-button-main');
      quizButtons.forEach(button => {
        button.addEventListener('click', function() {
          const slug = this.getAttribute('data-quiz-slug');
          if (slug && slug.trim() !== '') {
            openQuizModal(slug.trim());
          } else {
            alert('Quiz slug belirtilmemiş! Lütfen quiz ayarlarını kontrol edin.');
          }
        });
      });
    }

    async function openQuizModal(slug) {
      const modal = document.getElementById('quiz-modal');
      const container = document.getElementById('quiz-container');
      
      // Show modal
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      try {
        // Show loading
        container.innerHTML = getLoadingHTML();
        
        // Fetch quiz data (fallback to direct API if proxy fails)
        const proxyUrl = `/apps/quiz-app/api/quiz/public/${slug}`;
        const directUrl = `https://shopify-quiz-app.vercel.app/api/proxy/quiz/public/${slug}`;
        
        let url = proxyUrl;
        console.log('Trying proxy URL first:', url);
        
        let response = await fetch(url);
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        // If proxy fails, try direct API
        if (!response.ok) {
          console.log('Proxy failed, trying direct URL:', directUrl);
          url = directUrl;
          response = await fetch(url);
          console.log('Direct API response status:', response.status);
          console.log('Direct API response ok:', response.ok);
        }
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          throw new Error('Quiz bulunamadı veya aktif değil');
        }

        const data = await response.json();
        
        if (data.success && data.quiz) {
          currentQuiz = data.quiz;
          currentView = 'info';
          currentQuestionIndex = 0;
          selectedAnswers = [];
          allAnswers = {};
          renderQuiz();
        } else {
          throw new Error(data.error || 'Quiz yüklenemedi');
        }
      } catch (error) {
        console.error('Quiz loading error:', error);
        container.innerHTML = getErrorHTML(error.message);
      }
    }

    function closeQuizModal() {
      const modal = document.getElementById('quiz-modal');
      modal.style.display = 'none';
      document.body.style.overflow = '';
      currentQuiz = null;
    }

    function closeQuizModalIfOutside(event) {
      if (event.target === event.currentTarget) {
        closeQuizModal();
      }
    }

    function getLoadingHTML() {
      return `
        <div class="quiz-loading">
          <div class="quiz-loading-spinner"></div>
          <p>Quiz yükleniyor...</p>
        </div>
      `;
    }

    function getErrorHTML(message) {
      return `
        <div class="quiz-error">
          <div class="quiz-error-icon">❌</div>
          <p>${message}</p>
          <button onclick="closeQuizModal()" class="quiz-error-button">Kapat</button>
        </div>
      `;
    }

    function renderQuiz() {
      const container = document.getElementById('quiz-container');
      // Veritabanından gelen styles'ı kullan
      const styles = (currentQuiz.style_settings && Object.keys(currentQuiz.style_settings).length > 0) 
        ? { ...defaultStyles, ...currentQuiz.style_settings }
        : defaultStyles;
      
      let content = '';
      
      if (currentView === 'info') {
        content = renderQuizInfo(styles);
      } else if (currentView === 'question') {
        content = renderQuestion(styles);
      } else if (currentView === 'result') {
        content = renderResult(styles);
      }
      
      container.innerHTML = `
        <div class="quiz-wrapper">
          <!-- Close Button -->
          <button class="quiz-close-btn" onclick="closeQuizModal()" style="
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid white;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
          " onmouseover="this.style.background='rgba(0,0,0,0.9)'; this.style.transform='scale(1.05)'" 
             onmouseout="this.style.background='rgba(0,0,0,0.8)'; this.style.transform='scale(1)'">×</button>
          
          ${content}
          
          ${currentView !== 'result' ? renderNavigation() : ''}
        </div>
        
        <style>
          ${styles.customCSS || ''}
        </style>
      `;
      
      // Add event listeners after rendering
      addEventListeners();
    }

    function renderQuizInfo(styles) {
      return `
        <div class="quiz-info" style="
          background: ${styles.introBackgroundColor || styles.questionBackgroundColor || '#2c5aa0'};
          border-radius: ${styles.questionOptionBorderRadius || 24}px;
          font-family: ${styles.fontFamily || 'Arial, sans-serif'};
        ">
          ${currentQuiz.image ? `
            <div class="quiz-image" style="height: ${styles.introImageHeight || 200}px;">
              <img src="${currentQuiz.image}" alt="Quiz image" 
                   style="
                     border-radius: ${styles.introImageBorderRadius || 12}px;
                     border: ${styles.introImageBorderWidth || 0}px ${styles.introImageBorderType || 'solid'} ${styles.introImageBorderColor || '#ffffff'};
                   " />
            </div>
          ` : ''}
          
          <h1 class="quiz-title" style="
            font-size: ${styles.introTitleSize || 32}px;
            color: ${styles.introQuestionTextColor || '#ffffff'};
          ">
            ${currentQuiz.title}
          </h1>
          
          ${currentQuiz.description ? `
            <p class="quiz-description" style="
              font-size: ${styles.introDescriptionSize || 18}px;
              color: ${styles.introDescriptionTextColor || '#ffffff'};
            ">
              ${currentQuiz.description}
            </p>
          ` : ''}
          
          ${currentQuiz.questions.length > 0 ? `
            <button class="quiz-start-btn" data-action="start" style="
              background: ${styles.introStartButtonColor || '#ff6b6b'};
              color: ${styles.introStartButtonTextColor || '#ffffff'};
              font-size: ${styles.introButtonTextSize || 18}px;
              border: ${styles.introButtonBorderWidth || 0}px ${styles.introButtonBorderType || 'solid'} ${styles.introStartButtonBorderColor || '#ffffff'};
              border-radius: ${styles.introButtonBorderRadius || 12}px;
            ">
              🚀 Quiz'i Başlat
            </button>
          ` : ''}
        </div>
      `;
    }

    function renderQuestion(styles) {
      const question = currentQuiz.questions[currentQuestionIndex];
      if (!question) return '';

      const progress = ((currentQuestionIndex + 1) / currentQuiz.questions.length) * 100;

      return `
        <div class="quiz-question" style="
          background: ${styles.questionBackgroundColor || '#2c5aa0'};
          border-radius: ${styles.questionOptionBorderRadius || 24}px;
          font-family: ${styles.fontFamily || 'Arial, sans-serif'};
        ">
          <!-- Progress Bar -->
          <div class="quiz-progress">
            <div class="quiz-progress-bar" style="width: ${progress}%;"></div>
          </div>

          <!-- Question Counter -->
          <div class="quiz-counter">
            <span style="
              background: ${styles.counterBackgroundColor || 'rgba(255,255,255,0.2)'};
              color: ${styles.counterTextColor || '#ffffff'};
              font-size: ${styles.counterTextSize || 14}px;
              border: ${styles.counterBorderWidth || 0}px ${styles.counterBorderType || 'solid'} ${styles.counterBorderColor || '#ffffff'};
              border-radius: ${styles.counterBorderRadius || 20}px;
            ">
              Soru ${currentQuestionIndex + 1} / ${currentQuiz.questions.length}
            </span>
          </div>

          ${question.questionMedia ? `
            <div class="quiz-question-image" style="height: ${styles.questionImageHeight || 200}px;">
              <img src="${question.questionMedia}" alt="Question image" 
                   style="
                     border-radius: ${styles.questionImageBorderRadius || 12}px;
                     border: ${styles.questionImageBorderWidth || 0}px ${styles.questionImageBorderType || 'solid'} ${styles.questionImageBorderColor || '#ffffff'};
                   " />
            </div>
          ` : ''}

          <h2 class="quiz-question-text" style="
            font-size: ${styles.questionTextSize || 24}px;
            color: ${styles.questionTextColor || '#ffffff'};
          ">
            ${question.text}
          </h2>

          <div class="quiz-answers">
            ${question.answers.map(answer => `
              <div class="quiz-answer ${selectedAnswers.includes(answer.id) ? 'selected' : ''}" 
                   data-answer-id="${answer.id}"
                   style="
                     background: ${selectedAnswers.includes(answer.id) ? styles.questionSelectedOptionBackgroundColor || '#ff6b6b' : styles.questionOptionBackgroundColor || '#ffffff'};
                     border: ${styles.questionOptionBorderWidth || 2}px ${styles.questionOptionBorderType || 'solid'} ${selectedAnswers.includes(answer.id) ? styles.questionSelectedOptionBorderColor || '#ff6b6b' : styles.questionOptionBorderColor || '#ffffff'};
                     border-radius: ${styles.questionOptionBorderRadius || 12}px;
                     width: ${styles.questionOptionImageSize || 140}px;
                   ">
                
                <div class="quiz-answer-indicator ${selectedAnswers.includes(answer.id) ? 'selected' : ''}"></div>
                
                ${answer.answerMedia ? `
                  <div class="quiz-answer-image" style="height: ${Math.floor((styles.questionOptionImageSize || 140) * 0.4)}px;">
                    <img src="${answer.answerMedia}" alt="Answer image" />
                  </div>
                ` : ''}
                
                <span class="quiz-answer-text" 
                      style="
                        font-size: ${styles.questionOptionTextSize || 18}px;
                        color: ${selectedAnswers.includes(answer.id) ? styles.questionSelectedOptionTextColor || '#ffffff' : styles.questionOptionTextColor || '#000000'};
                      ">
                  ${answer.text}
                </span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderResult(styles) {
      return `
        <div class="quiz-result" style="
          background: ${styles.resultBackgroundColor || styles.questionBackgroundColor || '#2c5aa0'};
          border-radius: ${styles.questionOptionBorderRadius || 24}px;
          font-family: ${styles.fontFamily || 'Arial, sans-serif'};
        ">
          <div class="quiz-result-icon">🎉</div>
          <h2 class="quiz-result-title" style="
            font-size: ${styles.introTitleSize || 32}px;
            color: ${styles.resultTextColor || '#ffffff'};
          ">
            Quiz Tamamlandı!
          </h2>
          <p class="quiz-result-description" style="
            color: ${styles.resultTextColor || '#ffffff'};
            font-size: ${styles.introDescriptionSize || 18}px;
          ">
            Tebrikler! Quiz'i başarıyla tamamladınız.
          </p>
          <button class="quiz-finish-btn" data-action="finish" style="
            background: ${styles.resultButtonColor || styles.introStartButtonColor || '#ff6b6b'};
            color: ${styles.resultButtonTextColor || '#ffffff'};
            font-size: ${styles.introButtonTextSize || 18}px;
            border-radius: ${styles.introButtonBorderRadius || 12}px;
          ">
            Kapat
          </button>
        </div>
      `;
    }

    function renderNavigation() {
      const canGoPrevious = !(currentView === 'info');
      const canGoNext = !(currentView === 'question' && selectedAnswers.length === 0);
      const isLastQuestion = currentView === 'question' && currentQuestionIndex >= currentQuiz.questions.length - 1;
      // Veritabanından gelen styles'ı kullan
      const styles = (currentQuiz.style_settings && Object.keys(currentQuiz.style_settings).length > 0) 
        ? { ...defaultStyles, ...currentQuiz.style_settings }
        : defaultStyles;

      return `
        <div class="quiz-navigation">
          <button class="quiz-nav-btn quiz-prev-btn" 
                  data-action="previous" 
                  style="
                    background: ${styles.navPrevButtonColor || '#ffffff'};
                    color: ${styles.navPrevButtonTextColor || '#000000'};
                    font-size: ${styles.navButtonTextSize || 18}px;
                    border: ${styles.navButtonBorderWidth || 0}px ${styles.navButtonBorderType || 'solid'} ${styles.navButtonBorderColor || '#ffffff'};
                    border-radius: ${styles.navButtonBorderRadius || 12}px;
                  "
                  ${!canGoPrevious ? 'disabled' : ''}>
            ← Önceki
          </button>

          <div class="quiz-nav-status">
            ${currentView === 'info' 
              ? '🏠 Quiz Bilgileri' 
              : `🔥 Soru ${currentQuestionIndex + 1}/${currentQuiz.questions.length}`}
          </div>

          <button class="quiz-nav-btn quiz-next-btn" 
                  data-action="next" 
                  style="
                    background: ${styles.navOkIconColor || styles.introStartButtonColor || '#ff6b6b'};
                    color: ${styles.introStartButtonTextColor || '#ffffff'};
                    font-size: ${styles.navButtonTextSize || 18}px;
                    border: ${styles.navButtonBorderWidth || 0}px ${styles.navButtonBorderType || 'solid'} ${styles.navButtonBorderColor || '#ffffff'};
                    border-radius: ${styles.navButtonBorderRadius || 12}px;
                  "
                  ${!canGoNext ? 'disabled' : ''}>
            ${isLastQuestion ? 'Bitir' : 'Sonraki →'}
          </button>
        </div>
      `;
    }

    function addEventListeners() {
      // Start button
      const startBtn = document.querySelector('[data-action="start"]');
      if (startBtn) {
        startBtn.addEventListener('click', handleStart);
      }

      // Answer options
      const answerOptions = document.querySelectorAll('.quiz-answer');
      answerOptions.forEach(option => {
        option.addEventListener('click', handleAnswerSelect);
      });

      // Navigation buttons
      const prevBtn = document.querySelector('[data-action="previous"]');
      if (prevBtn) {
        prevBtn.addEventListener('click', handlePrevious);
      }

      const nextBtn = document.querySelector('[data-action="next"]');
      if (nextBtn) {
        nextBtn.addEventListener('click', handleNext);
      }

      // Finish button
      const finishBtn = document.querySelector('[data-action="finish"]');
      if (finishBtn) {
        finishBtn.addEventListener('click', closeQuizModal);
      }
    }

    function handleStart() {
      if (currentQuiz.questions.length > 0) {
        currentView = 'question';
        currentQuestionIndex = 0;
        selectedAnswers = [];
        allAnswers = {};
        renderQuiz();
      }
    }

    function handleAnswerSelect(event) {
      const answerId = event.currentTarget.getAttribute('data-answer-id');
      const question = currentQuiz.questions[currentQuestionIndex];
      
      if (question.allowMultipleSelection) {
        if (selectedAnswers.includes(answerId)) {
          selectedAnswers = selectedAnswers.filter(id => id !== answerId);
        } else {
          selectedAnswers.push(answerId);
        }
      } else {
        selectedAnswers = [answerId];
      }
      
      renderQuiz();
    }

    function handlePrevious() {
      if (currentView === 'question' && currentQuestionIndex > 0) {
        const newIndex = currentQuestionIndex - 1;
        currentQuestionIndex = newIndex;
        
        // Restore previous answers
        const questionId = currentQuiz.questions[newIndex].id;
        selectedAnswers = allAnswers[questionId] || [];
        renderQuiz();
      } else if (currentView === 'question' && currentQuestionIndex === 0) {
        currentView = 'info';
        selectedAnswers = [];
        renderQuiz();
      }
    }

    function handleNext() {
      if (currentView === 'info') {
        if (currentQuiz.questions.length > 0) {
          currentView = 'question';
          currentQuestionIndex = 0;
          selectedAnswers = [];
          renderQuiz();
        }
      } else if (currentView === 'question' && selectedAnswers.length > 0) {
        // Save current answers
        const questionId = currentQuiz.questions[currentQuestionIndex].id;
        allAnswers[questionId] = [...selectedAnswers];

        if (currentQuestionIndex < currentQuiz.questions.length - 1) {
          const newIndex = currentQuestionIndex + 1;
          currentQuestionIndex = newIndex;
          
          // Load answers for next question
          const nextQuestionId = currentQuiz.questions[newIndex].id;
          selectedAnswers = allAnswers[nextQuestionId] || [];
          renderQuiz();
        } else {
          // Quiz completed
          currentView = 'result';
          renderQuiz();
        }
      }
    }

    // Make closeQuizModal global
    window.closeQuizModal = closeQuizModal;
    window.closeQuizModalIfOutside = closeQuizModalIfOutside;
  })();
</script>

{% schema %}
{
  "name": "Quiz Button",
  "target": "section",
  "templates": ["index", "product", "collection", "page", "blog", "article", "search", "cart"],
  "settings": [
    {
      "type": "text",
      "id": "quiz_slug",
      "label": "Quiz Slug",
      "info": "Quiz'in slug'ını girin (örn: product-finder)"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Quiz Başlat"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Background Color",
      "default": "#ff6b6b"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Button Border Color",
      "default": "#ff6b6b"
    },
    {
      "type": "range",
      "id": "border_width",
      "label": "Border Width",
      "min": 0,
      "max": 10,
      "step": 1,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "default": 25,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "button_padding",
      "label": "Button Padding",
      "min": 5,
      "max": 30,
      "step": 1,
      "default": 15,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font Size",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 16,
      "unit": "px"
    }
  ]
}
{% endschema %}